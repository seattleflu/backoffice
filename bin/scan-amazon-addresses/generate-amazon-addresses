#!/bin/bash
# usage: generate-amazon-addresses [<s3 output url>]
#
# Exports the Amazon Care Outgoing Report from SCAN REDCap project and uploads
# to Amazon S3 bucket.
#
set -euo pipefail

: "${REDCAP_API_URL:?The REDCAP_API_URL environment variable is required.}"

bin="$(dirname "$0")"

main() {
    for arg; do
        case "$arg" in
            --help)
                print-help
                exit 0;;
        esac
    done

    local addresses="${1:-s3://698378617677-prod-or-uwscan-intake/intake/sample.csv}"

    export-redcap-data \
        | "$bin"/aws-assume-role-wrapper aws s3 cp - "$addresses" \
            --acl bucket-owner-full-control \
            --quiet
}

# Exports reports using all given REDCap project API tokens, output as one csv.
export-redcap-data() {
    REDCAP_API_TOKEN="$REDCAP_API_TOKEN_EN" REDCAP_REPORT_ID="$REDCAP_REPORT_ID_EN" "$bin"/export-redcap-report
}

print-help() {
    # Print the help comments at the top of this file ($0)
    local line
    while read -r line; do
        if [[ $line =~ ^#! ]]; then
            continue
        elif [[ $line =~ ^# ]]; then
            line="${line/##/}"
            line="${line/# /}"
            echo "$line"
        else
            break
        fi
    done < "$0"
}

main "$@"
