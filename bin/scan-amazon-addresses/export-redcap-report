#!/bin/bash
# usage: export-redcap-report
#
# Exports report from a REDCap project as CSV.
#
set -euo pipefail

: "${REDCAP_API_URL:?The REDCAP_API_URL environment variable is required.}"
: "${REDCAP_API_TOKEN:?The REDCAP_API_TOKEN environment variable is required.}"
: "${REDCAP_REPORT_ID:?The REDCAP_REPORT_ID environment variable is required.}"


curl -fsSL -H "Content-Type: application/x-www-form-urlencoded" \
      -H "Accept: application/json" \
      -X POST \
      -d @<(echo "token=$REDCAP_API_TOKEN") \
      -d format=csv \
      -d content=report \
      -d @<(echo "report_id=$REDCAP_REPORT_ID") \
      -d rawOrLabel=label \
      -d returnFormat=json \
      "$REDCAP_API_URL"
