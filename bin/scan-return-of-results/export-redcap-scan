#!/usr/bin/env python3
# usage: export-redcap-scan
#
# Exports participant information from the SCAN REDCap projects as NDJSON.
#
import json
from id3c.cli import redcap
from os import environ
from typing import NamedTuple, Optional


REDCAP_API_URL = environ["REDCAP_API_URL"]
REDCAP_API_TOKEN = lambda lang: environ[(
    ("REDCAP_API_TOKEN_IRB_%s" % lang)
        .upper()
        .replace("-", "_")
)]

FIELDS = [
    "record_id",
    "participant_first_name",
    "participant_last_name",
    "birthday",
    "utm_tube_barcode_2",
    "reenter_barcode",
    "return_utm_barcode",
    "contacted",
]

REQUIRED_FIELDS = [
    "participant_first_name",
    "participant_last_name",
    "birthday",
]


class ScanProject(redcap.Project):
    lang: str

    def __init__(self, project_id: str, lang: str) -> None:
        super().__init__(REDCAP_API_URL, REDCAP_API_TOKEN(lang), project_id)
        self.lang = lang


def main():
    projects = [
        # SCAN (research study)
        ScanProject(22461, "en"),
        ScanProject(22475, "es"),
        ScanProject(22474, "zh-Hant"),
    ]

    for project_records in map(fetch_records, projects):
        for record in project_records:
            print(json.dumps(record, indent = None, separators = ",:"), flush = True)


def fetch_records(project):
    for record in project.records(fields = FIELDS, raw = True):
        if not all(len(record[field]) for field in REQUIRED_FIELDS):
            continue

        yield record


if __name__ == "__main__":
    main()
