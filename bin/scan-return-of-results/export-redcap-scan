#!/bin/bash
# usage: export-redcap-scan
#
# Exports participant information from the SCAN REDCap projects as NDJSON.
#
set -euo pipefail

: "${REDCAP_API_URL:?The REDCAP_API_URL environment variable is required.}"
: "${REDCAP_API_TOKEN:?The REDCAP_API_TOKEN environment variable is required.}"

fields="record_id,participant_first_name,participant_last_name,birthday,pre_scan_barcode,utm_tube_barcode_2,reenter_barcode,return_utm_barcode,contacted"
filters="[participant_first_name] != '' and [participant_last_name] != '' and [birthday] != ''"

curl -fsSL -H "Content-Type: application/x-www-form-urlencoded" \
      -H "Accept: application/json" \
      -X POST \
      -d @<(echo "token=$REDCAP_API_TOKEN") \
      -d format=json \
      -d content=record \
      -d type=flat \
      -d fields="$fields" \
      -d filterLogic="$filters" \
      -d exportDataAccessGroups=false \
      -d returnFormat=json \
      "$REDCAP_API_URL" \
| jq --compact-output '.[]'
