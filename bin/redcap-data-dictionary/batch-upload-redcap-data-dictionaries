#!/bin/bash
# usage: batch-upload-redcap-data-dictionaries
#
set -euo pipefail

: "${REDCAP_API_URL:?The REDCAP_API_URL environment variable is required.}"
: "${REDCAP_API_TOKEN_TEST:?The REDCAP_API_TOKEN_TEST environment variable is required.}"

# Change to the ./bin/redcap-data-dictionary directory in the backoffice checkout
cd "$(dirname "$0")"

# Uploads new data dictionaries using all given REDCap project API tokens.
upload-language-data-dictionary() {
    # Spanish
    REDCAP_API_TOKEN="$REDCAP_API_TOKEN_ES" \
        ./upload-data-dictionary \
            --html-attribute lang:es \
            --import-to-redcap \
            --exported-data-dictionary <(REDCAP_API_TOKEN="$REDCAP_API_TOKEN_ES" ./download-data-dictionary) \
            --output "./data-dictionary-test.json"

    # Vietnamese
    REDCAP_API_TOKEN="$REDCAP_API_TOKEN_VI" \
        ./upload-data-dictionary \
            --html-attribute lang:vi \
            --import-to-redcap \
            --exported-data-dictionary <(REDCAP_API_TOKEN="$REDCAP_API_TOKEN_VI" ./download-data-dictionary) \
            --output "./data-dictionary-test.json"

    # Chinese (simplified)
    REDCAP_API_TOKEN="$REDCAP_API_TOKEN_ZH_HANS" \
        ./upload-data-dictionary \
            --html-attribute lang:zh_Hans \
            --import-to-redcap \
            --exported-data-dictionary <(REDCAP_API_TOKEN="$REDCAP_API_TOKEN_ZH_HANS" ./download-data-dictionary) \
            --output "./data-dictionary-test.json"
}

upload-language-data-dictionary
